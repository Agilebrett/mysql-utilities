<?xml version="1.0" encoding="utf-8"?>
<Wix xmlns='http://schemas.microsoft.com/wix/2006/wi'
  xmlns:util='http://schemas.microsoft.com/wix/UtilExtension'>

  <?define RTMProductVersion="1.3.0" ?>

  <?define PackageCode="*"?>

  <Product Id="*"
   Name="MySQL Utilities"
   Version="$(var.Version)"
   Manufacturer="Oracle Corporation"
   Language="1033"
   UpgradeCode="$(var.UpgradeCode)">

    <Package Id='$(var.PackageCode)'
             Compressed="yes" InstallerVersion="200"
             Description="MySQL Utilities Installer"
             Comments="$(var.Copyright)"
             InstallScope="perMachine" />

    <!-- <MajorUpgrade AllowDowngrades="no" Disallow="no" AllowSameVersionUpgrades="yes"
     DowngradeErrorMessage="A later version of $(var.ProductName) is already installed."/> -->

    <Property Id="PREVIOUSVERSIONSINSTALLED" Secure="yes" />
    <Upgrade Id="$(var.UpgradeCode)">  
    <!-- <UpgradeVersion
      Minimum="1.0.0"
      Property="OLDVERSIONFOUND"
      OnlyDetect="no"
      IncludeMinimum="yes" IncludeMaximum="no" />
    </Upgrade> -->
    <UpgradeVersion Minimum="$(var.Version)"
                    IncludeMinimum="no"
                    OnlyDetect="no"
                    Language="1033"
                    Property="NEWPRODUCTFOUND" />
    <UpgradeVersion Minimum="$(var.RTMProductVersion)"
                    IncludeMinimum="yes"
                    Maximum="$(var.Version)"
                    IncludeMaximum="yes"
                    Language="1033"
                    Property="UPGRADEFOUND" />
    </Upgrade>

    <Media Id="1" Cabinet="ConnectorPython_Python.cab" EmbedCab="yes"/>

    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFilesFolder" Name="ProgFilesFolder">
        <Directory Id="CompanyDir" Name="MySQL">
          <Directory Id="INSTALLDIR" Name="MySQL Utilities"/>
        </Directory>
      </Directory>
      <Directory Id="ProgramMenuFolder" Name="Programs">
        <Directory Id="CompanyMenu" Name="MySQL">
          <Directory Id="UtilsMenu" Name="MySQL Utilities">
            <Directory Id="DocMenu" Name="Documentation"/>
          </Directory>
        </Directory>
      </Directory>
    </Directory>

    <DirectoryRef Id="CompanyMenu">
      <Component Id="CompanyMenuComponent" Guid="c97ca399-7d02-4b9c-9a96-7783c33c8f24">
       <RemoveFolder Id="CompanyMenu" On="uninstall"/>
       <RegistryKey Root="HKCU"
        Key="Software\MySQL\MySQL Utilities"
        Action="createAndRemoveOnUninstall">
         <RegistryValue Type="string" Name="Version" Value="$(var.Version)"
          KeyPath="yes"/>
         <RegistryValue Type="string" Name="Location" Value="[INSTALLDIR]"/>
       </RegistryKey>
       <RegistryKey Root="HKCU"
        Key="Software\MySQL AB\MySQL Utilities"
        Action="createAndRemoveOnUninstall">
         <RegistryValue Type="string" Name="Version" Value="$(var.Version)"/>
         <RegistryValue Type="string" Name="Location" Value="[INSTALLDIR]"/>
       </RegistryKey>
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="INSTALLDIR">
      <Component Id="SetupRegistry" Guid="ab4f2462-3dd8-4e7d-ad31-f81a652ef1fb">
        <RegistryKey Root="HKCU"
         Key="Software\MySQL\MySQL Utilities"
         Action="createAndRemoveOnUninstall">
          <RegistryValue Type="string" Name="Version" Value="$(var.Version)"
           KeyPath="yes"/>
          <RegistryValue Type="string" Name="Location" Value="[INSTALLDIR]"/>
        </RegistryKey>
        <RegistryKey Root="HKCU"
         Key="Software\MySQL AB\MySQL Utilities"
         Action="createAndRemoveOnUninstall">
          <RegistryValue Type="string" Name="Version" Value="$(var.Version)"/>
          <RegistryValue Type="string" Name="Location" Value="[INSTALLDIR]"/>
        </RegistryKey>
      </Component>
      <Component Id="SetupEnv" Guid="b692b935-6205-4fff-b9d0-a88eb66295aa">
        <CreateFolder>
          <util:PermissionEx User="Users" GenericAll="yes" />
        </CreateFolder>
        <Environment Id="SystemPath" Name="PATH"
         Action="set" Value="[INSTALLDIR]"
         Part="last" System="yes" Permanent="no"/>
      </Component>
      <Component Id="UtilsExe" Guid="ad3556a3-1c3c-4b9e-916f-f00792649bab">
      </Component>
      <Component Id="UtilsDLL" Guid="2804c1fa-f8df-484a-9a56-47bbe82bff79">
        <File Id="dll_python" Name="python$(var.PythonMajor)$(var.PythonMinor).dll"
         Source="$(var.BuildDir)\python$(var.PythonMajor)$(var.PythonMinor).dll" DiskId="1"/>
      </Component>
      <Component Id="UtilsPYD" Guid="a657a7e5-07df-4de1-bf9e-4ae575fe8585">
        <File Id="pyd_bz2" Name="bz2.pyd"
         Source="$(var.BuildDir)\bz2.pyd" DiskId="1"/>
        <File Id="pyd_pyexpat" Name="pyexpat.pyd"
         Source="$(var.BuildDir)\pyexpat.pyd" DiskId="1"/>
        <File Id="pyd_select" Name="select.pyd"
         Source="$(var.BuildDir)\select.pyd" DiskId="1"/>
        <File Id="pyd_unicodedata" Name="unicodedata.pyd"
         Source="$(var.BuildDir)\unicodedata.pyd" DiskId="1"/>
        <File Id="pyd__ctypes" Name="_ctypes.pyd"
         Source="$(var.BuildDir)\_ctypes.pyd" DiskId="1"/>
        <File Id="pyd__hashlib" Name="_hashlib.pyd"
         Source="$(var.BuildDir)\_hashlib.pyd" DiskId="1"/>
        <File Id="pyd__multiprocessing" Name="_multiprocessing.pyd"
         Source="$(var.BuildDir)\_multiprocessing.pyd" DiskId="1"/>
        <File Id="pyd__socket" Name="_socket.pyd"
         Source="$(var.BuildDir)\_socket.pyd" DiskId="1"/>
        <File Id="pyd__ssl" Name="_ssl.pyd"
         Source="$(var.BuildDir)\_ssl.pyd" DiskId="1"/>
      </Component>

      <Component Id="UtilsPyLib" Guid="dbc3ab31-937d-452d-993f-7130c75188ac">
        <File Id="zip_library" Name="library.zip"
         Source="$(var.BuildDir)\library.zip" DiskId="1"/>
      </Component>

      <Component Id="UtilsDocs" Guid="68608e06-d064-4909-9e3e-a60bd6f3f09b">
        <File Id="README" Name="README_com.txt"
         Source="$(var.BuildDir)\README_com.txt" DiskId="1"/>
        <File Id="LICENSE" Name="LICENSE_com.txt"
         Source="$(var.BuildDir)\LICENSE_com.txt" DiskId="1"/>
      </Component>

    </DirectoryRef>

    <DirectoryRef Id="UtilsMenu">
      <Component Id="UtilsShortcuts" Guid="6eb1d27b-7be1-41da-a3e2-616b3494c1dc">
        <RemoveFolder Id="UtilsMenu" On="uninstall"/>
        <RegistryKey Root="HKCU"    
         Key="Software\MySQL\MySQL Utilities"
         Action="createAndRemoveOnUninstall">
          <RegistryValue Type="string" Name="Version" Value="$(var.Version)"
           KeyPath="yes"/>
          <RegistryValue Type="string" Name="Location" Value="[INSTALLDIR]"/>
        </RegistryKey>
        <RegistryKey Root="HKCU"
         Key="Software\MySQL AB\MySQL Utilities"
         Action="createAndRemoveOnUninstall">
          <RegistryValue Type="string" Name="Version" Value="$(var.Version)"/>
          <RegistryValue Type="string" Name="Location" Value="[INSTALLDIR]"/>
        </RegistryKey>
        <Shortcut Id="exec_mysqluc"
                  Name="MySQL Utilities Console"
                  Description="MySQL Utilities Console"
                  Target="[INSTALLDIR]mysqluc.exe"
                  WorkingDirectory="INSTALLDIR"/>
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="DocMenu">
      <Component Id="UtilsManuals" Guid="0ee2012b-0f38-45e1-9b62-a18ec82879a4">
        <RemoveFolder Id="DocMenu" On="uninstall"/>
        <RegistryKey Root="HKCU"
         Key="Software\MySQL\MySQL Utilities"
         Action="createAndRemoveOnUninstall">
          <RegistryValue Type="string" Name="Version" Value="$(var.Version)"
           KeyPath="yes"/>
          <RegistryValue Type="string" Name="Location" Value="[INSTALLDIR]"/>
        </RegistryKey>
        <RegistryKey Root="HKCU"
         Key="Software\MySQL AB\MySQL Utilities"
         Action="createAndRemoveOnUninstall">
          <RegistryValue Type="string" Name="Version" Value="$(var.Version)"/>
          <RegistryValue Type="string" Name="Location" Value="[INSTALLDIR]"/>
        </RegistryKey>
        <util:InternetShortcut Id="url_utils_fabric"
         Name="MySQL Utilities - MySQL Fabric Manual (online)"
         Target="http://dev.mysql.com/doc/index-utils-fabric.html"/>
      </Component>
    </DirectoryRef>

    <Feature Id="Complete" Level="1" ConfigurableDirectory="INSTALLDIR"
      Title="MySQL Utilities $(var.Version)" Description="Complete">
      <Feature Id="Install" Level="1">
        <ComponentRef Id="SetupRegistry"/>
        <ComponentRef Id="SetupEnv"/>
        <ComponentRef Id="UtilsExe"/>
        <ComponentRef Id="UtilsDLL"/>
        <ComponentRef Id="UtilsPYD"/>
        <ComponentRef Id="UtilsPyLib"/>
        <ComponentRef Id="UtilsDocs"/>
        <ComponentRef Id="UtilsManuals"/>
        <ComponentRef Id="UtilsShortcuts"/>
        <ComponentRef Id="CompanyMenuComponent"/>
      </Feature>
    </Feature>

    <!-- Prevent downgrading -->
    <CustomAction Id="PreventDowngrading" Error="Newer version already installed." />

    <InstallExecuteSequence>
      <LaunchConditions After='AppSearch' />
      <Custom Action="PreventDowngrading" After="FindRelatedProducts">NEWPRODUCTFOUND</Custom>
      <RemoveExistingProducts After='InstallValidate' />
    </InstallExecuteSequence>

    <!-- Launch mysqluc after installation -->
    <Property Id="WIXUI_EXITDIALOGOPTIONALTEXT" Value="!(loc.ExitDialogOptionalText)"/>
    <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOX" Value="0"/>
    <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT"
     Value="Launch MySQL Utilities Console"/>
    <CustomAction Id="LaunchApplication" Directory="INSTALLDIR"
     ExeCommand="[SystemFolder]cmd.exe /C start mysqluc.exe" />

    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLDIR"/>
    <UI>
      <UIRef Id="WixUI_InstallDir"/>
      <Publish Dialog="WelcomeDlg" Control="Next" Event="NewDialog"
       Value="InstallDirDlg" Order="2">1</Publish>
      <Publish Dialog="InstallDirDlg" Control="Back" Event="NewDialog"
       Value="WelcomeDlg" Order="2">1</Publish>
      <Publish Dialog="ExitDialog" Control="Finish" Event="DoAction" 
       Value="LaunchApplication">WIXUI_EXITDIALOGOPTIONALCHECKBOX = 1 and NOT Installed</Publish>
    </UI>
    <WixVariable Id="WixUIBannerBmp"
     Value="$(var.BitmapDir)\WixUIBanner_Utilities.bmp"/>
    <WixVariable Id="WixUIDialogBmp"
     Value="$(var.BitmapDir)\WixUIDialog_Utilities.bmp"/>

    <Property Id="Version" Value="$(var.Version)"/>
  </Product>
</Wix>
